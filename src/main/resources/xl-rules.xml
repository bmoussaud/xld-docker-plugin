<?xml version="1.0"?>
<!--
    Note: If you modify this file and automatic reloading is disabled in `planner.conf`, you must restart the XL Deploy server.
-->
<rules xmlns="http://www.xebialabs.com/xl-deploy/xl-rules">
  <rule name="docker.Container.Create" scope="deployed">
    <conditions>
      <type>docker.RunContainer</type>
      <operation>CREATE</operation>
      <operation>MODIFY</operation>
    </conditions>
    <steps>
      <!--
      <os-script>
        <description expression="true">"Pull the container %s (%s)" % (deployed.name, deployed.image) </description>
        <order>55</order>
        <script>docker/docker-pull</script>
      </os-script>
-->
      <os-script>
        <description expression="true">"Run the container %s (%s)" % (deployed.name, deployed.image) </description>
        <order>65</order>
        <script>docker/docker-run</script>
      </os-script>
      <wait>
        <order>65</order>
        <description expression="true">"Waiting for 10 seconds" </description>
        <seconds>10</seconds>
      </wait>
      <os-script>
        <description expression="true">"Dump the logs of the container %s" % (deployed.name) </description>
        <order>65</order>
        <script>docker/docker-log</script>
      </os-script>
    </steps>
  </rule>
  <rule name="docker.Container.Destroy" scope="deployed">
    <conditions>
      <type>docker.RunContainer</type>
      <operation>DESTROY</operation>
      <operation>MODIFY</operation>
    </conditions>
    <steps>
      <os-script>
        <description expression="true">"Stop the container %s (%s)" % (previousDeployed.name, previousDeployed.image) </description>
        <order>35</order>
        <script>docker/docker-stop</script>
      </os-script>
      <os-script>
        <description expression="true">"Remove the container %s (%s)" % (previousDeployed.name, previousDeployed.image) </description>
        <order>35</order>
        <script>docker/docker-rm</script>
      </os-script>
    </steps>
  </rule>

    <rule name="smoketest.RunHttpRequest.docker" scope="deployed">
    <conditions>
      <type>smoketest.ExecutedDockerizedHttpRequestTest</type>
      <operation>CREATE</operation>
      <operation>MODIFY</operation>
      <operation>NOOP</operation>
    </conditions>
    <steps>
      <os-script>
        <script>docker/run_command</script>
        <order>102</order>
        <description expression="true">"Run '%s' on %s" % (deployed.name, deployed.container.name)</description>
        <classpath-resources>
          <value>smoketest/execute-http-request.sh.ftl</value>
        </classpath-resources>
        <target-host expression="true">deployed.container.host</target-host>
      </os-script>
    </steps>
  </rule>


</rules>
